;---------------------------------------CONF    EQU #77DATA    EQU #57CMD_17  EQU %01000000+17;Single ReadCMD_24  EQU %01000000+24;Single Write;---------------------------------------RDDSEsd ;i:HL(4) - Sector number;             DE - Address        PUSH DE        LD E,(HL):INC HL        LD D,(HL):INC HL        LD C,(HL):INC HL        LD B,(HL)        POP HL:LD A,B:CP #FF:RET Z        CALL CMD17:JR NZ,$        CALL WTDO:CP #FE:JR NZ,$        CALL READSsd,SNB        JP CSH;---------------------------------------SDDSEsd ;i:HL(4) - Sector number;             DE - Address        PUSH DE        LD E,(HL):INC HL        LD D,(HL):INC HL        LD C,(HL):INC HL        LD B,(HL)        POP HL:LD A,B:CP #FF:RET Z        XOR A:IN A,(CONF)        AND 2:JR NZ,XORK        LD A,B:OR C,D,E        LD A,3:RET Z        CALL CMD24:JR NZ,$        CALL SAVDSsd,DRESP,SNB        JP CSH;-------XORK    XOR A:RET;---------------------------------------READSsd PUSH BC,DE        LD BC,DATA        LD D,8RZD1.64     INI        DEC D:JP NZ,RZD1        IN A,A        POP DE,BC        RET;-------SAVDSsd PUSH BC,DE        LD BC,DATA,A,#FE:OUT A        LD D,8SVD1.64     OUTI        DEC D:JP NZ,SVD1        LD A,#FF        OUT A,A        POP DE,BC        RET;---------------------------------------CSH     PUSH BC,AF        LD BC,CONF,A,%00000011:OUT A        LD BC,DATA,A,#FF:OUT A        POP AF,BC        RETCSL     PUSH BC,AF        LD BC,CONF,A,%00000001:OUT A        LD BC,DATA,A,#FF:OUT A        POP AF,BC        JP WAITSNB     PUSH BC,AF        LD B,16SnB     XOR A:IN A,(DATA):DJNZ SnB        POP AF,BC        RET;---------------------------------------CMD17   LD A,CMD_17CMDz    PUSH HL,DE,BC        LD L,C,H,B        LD C,A        LD A,(BLKT):OR A:JR NZ,CMzz        EX DE,HL:ADD HL,HL        EX DE,HL:ADC HL,HL        LD H,L,L,D,D,E,E,ACMzz    CALL CSH        CALL CSL        LD A,C,BC,DATA:OUT A        OUT H        OUT L        OUT D        OUT E        LD A,#FF:OUT A        POP BC,DE,HL        JP RESPCMD24   LD A,CMD_24:JR CMDz;---------------------------------------RESP    PUSH DE,BC        LD BC,DATA,D,10RESp    IN A:BIT 7,A:JR Z,REZ        DEC D:JR NZ,RESp:INC DREZ     POP BC,DE        RET;-------WTDO    PUSH BC        LD BC,DATA:IN A:CP #FF:JR Z,$-4        POP BC        RETWAIT    PUSH BC,AF        LD BC,DATA:IN A:INC A:JR NZ,$-3        POP AF,BC        RET;-------DRESP   PUSH BC,AF        LD BC,DATA        IN A:CP #FF:JR Z,$-4        AND #1F:CP 5:JR NZ,ER        IN A:OR A:JR Z,$-3        POP AF,BC        RETER      AND 15:ADD A,240        LD BC,#0FAF:OUT A        CALL SDOFF        JR $;-------SDOFF   XOR A        OUT (CONF),A        OUT (DATA),A        RET;---------------------------------------