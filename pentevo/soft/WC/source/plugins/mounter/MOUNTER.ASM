;TR-DOS MOUNTER v1.2;(C) BUDDER/MGN 2015;---------------------------------------        ORG #6000;-------WLD     EQU #6000+6BLKT    EQU #6000+21RESDNT  EQU #5B00Vmod    EQU #00AFVpag    EQU #01AFSYS     EQU #20AFPE0     EQU #21AFPW0     EQU #10AFPW2     EQU #12AFPW3     EQU #13AFVFDD    EQU #29AFBLKZ    EQU 4EMU     EQU #6200+(BLKZ*#0200)NV29AF  EQU #B0;-------RAMD    EQU #C0RAMDE   EQU #C0+#28;---------------------------------------;HEADER:        DS 16        DB "WildCommanderMDL";    Header        DB #04;                  Version        DB 0;                       Type        DB 3; Pages        DB 0; Page to #8000;-------        DB 0,BLKZ; CODE        DB 1,32;   page to #FF        DB 2,16;   #FE.3      DB 0,0;-------        DS 16;-------        DB "TRD"        DB "SCL"        DS 30*3;-------        DB 0;-------        DW #0000,#0010; MAX SIZE;-------        DB "TR-DOS Mounter v"        DB "1.2             ";-------        DB 3;    3 - by EXT or From menu;-------        DS 256;---------------------------------------        ORG #8000,#6200;-------LOBU    EQU #A000LOBE    EQU LOBU+#1000LOB2    EQU #B000;---------------------------------------PLUGIN  PUSH AF,HL,DE:CALL GEDPL        POP DE,HL,AF        OR A:JP Z,EXTENS        CP 3:RET NZ;-------MENUS   CALL RSoDIZ:JR NZ,MOX        LD A,(CUZ2)        DEC A:JR Z,MORS        DEC A:JR Z,DIZMAMOX     LD A,(ESTAT)        RET;-------DIZMA_LD HL,TXT2,DE,#0004,BC,12        CALL DRIVEZ,Z,DIZMAUN:JR MOX;-------MORS_LD HL,TXT1,DE,#0002,BC,15        CALL DRIVEZ,Z,MOUNTRS:JR MOX;-------RSoDIZ  LD IX,MEWND:CALL PRWOW        LD HL,ME05,DE,#0102:CALL TXTPRMADI    EI:HALT:CALL CURSOR        CALL UPPP,NZ,UPC        CALL DWWW,NZ,DNC        CALL ESC:JR NZ,ADI        CALL ENKE:JR Z,MADIMAD     LD IX,MEWND:CALL RRESB        XOR A        RET;-------ADI     CALL MAD:INC A:RET;---------------------------------------GOTRDOS LD IX,TRWND:CALL PRWOWTRMAIN  EI:HALT:CALL CURSOR        CALL UPPP,NZ,UPC        CALL DWWW,NZ,DNC        CALL ENKE:JR NZ,TRGO        CALL ESC:JR Z,TRMAINHAXHAX  LD IX,TRWND:JP RRESBTRGO    LD A,(IX+12)        CP 2:JR Z,RBAS128        CP 1:JR NZ,HAXHAXRDOS    CALL RINIT:JP RESDNTRBAS128 CALL USPO        CALL RINIT        JP RESDNT+RESID2-RESIDERINIT   DI        LD A,63,I,A:IM 1        LD IY,#5C3A        LD HL,#5800,DE,HL:INC DE        LD (HL),L        LD BC,#0300-1:LDIR        XOR A        LD BC,#EFF7:OUT A        LD BC,PE0,A,%01000000:OUT A        LD BC,PW0:LD A,%00000000:OUT A        XOR A        LD BC,SYS:OUT A        LD BC,Vmod:OUT A        LD BC,Vpag,A,5:OUT A        LD HL,RESIDE        LD DE,RESDNT        LD BC,48:LDIR        LD HL,#2758:EXX        RETRESIDE  LD BC,PW2,A,2:OUT A        LD BC,PW3:XOR A:OUT A        LD BC,#7FFD,A,16:OUT A        LD HL,0:PUSH HL        JP #3D2FRESID2  LD BC,PW2,A,2:OUT A        LD BC,PW3:XOR A:OUT A        JP 0;---------------------------------------EXTENS  CALL EXTCHE:JR NZ,NOT_TRD        LD (DAHL),HL,(DADE),DE        LD A,L:OR A:JR NZ,YA        OR H,E:JR Z,YA        LD A,D:OR A:JR NZ,YA        LD L,H,A,E:AND %00001111:LD H,A        SRL H:RR L:JR NC,$+3:INC HL.2      ADD HL,HL        LD (DABB),HL        CALL CHECK:JR NZ,YA        LD HL,TXT0,DE,#0004,BC,13        CALL DRIVEZ,Z,MOUNTRDYA      LD A,(ESTAT)        RET;-------NOT_TRD LD HL,TXT3,DE,#0002,BC,16        CALL DRIVEZ,Z,MOUNRAM        JR YA;---------------------------------------DRIVEZ  PUSH HL,DE,BC        CALL INDICA        LD IX,PLWND:CALL PRWOW        POP BC,DE,HL        CALL PRSRW        LD A,%11110111:CALL PRIAT        LD HL,ME01,DE,#0102:CALL TXTPR        LD A,1:CALL YNMAIN    EI:HALT:XOR A:CALL YN,CURSOR        CALL UPPP,NZ,UPC        CALL DWWW,NZ,DNC        CALL ESC:JR NZ,AIN        CALL ENKE:JR Z,MAIN        LD A,#FF:CALL YN:JR NZ,AINMAJ     LD IX,PLWND:CALL RRESB        XOR A        RET;-------AIN     CALL MAJ:INC A:RET;-------UPC     LD A,(IX+12):CP 1:RET Z        CALL CURSER        DEC (IX+12)        JP CURSORDNC     LD A,(IX+12):CP (IX+13):RET NC        CALL CURSER        INC (IX+12)        JP CURSOR;---------------------------------------INDICA  DI        LD BC,#DFF7,A,NV29AF:OUT A        LD B,#BF:IN E        LD BC,#202A        LD A,B:BIT 0,E:JR Z,$+3:LD A,C        LD (ME01+12),A        LD A,B:BIT 1,E:JR Z,$+3:LD A,C        LD (ME02+12),A        LD A,B:BIT 2,E:JR Z,$+3:LD A,C        LD (ME03+12),A        LD A,B:BIT 3,E:JR Z,$+3:LD A,C        LD (ME04+12),A;-------        LD A,#FE:CALL MNGC        LD A,(#C008),DE,ME01+13:CALL ITM        LD A,(#C009),DE,ME02+13:CALL ITM        LD A,(#C00A),DE,ME03+13:CALL ITM        LD A,(#C00B),DE,ME04+13:CALL ITM        RET;-------ITM     LD BC,3        OR A:JR Z,RS_IT        DEC A:JR Z,HDM_IT        DEC A:JR Z,HDS_IT        DEC A:JR Z,SD_IT        DEC A        DEC A:JR Z,RD_IT;-------        LD HL,SPCSPI     LDIR        RET;-------RS_IT   LD HL,RS2:JR SPIHDM_IT  LD HL,TRD:JR SPIHDS_IT  LD HL,TRD:JR SPISD_IT   LD HL,TRD:JR SPIRD_IT   LD HL,RAM:JR SPI;---------------------------------------MOUNT   CALL MOO1        CALL MOO2        RET;-------MOUNTRD LD IX,STWND:CALL PRWOW        LD HL,TXT5,DE,#0101:CALL TXTPR        CALL MOO1        CALL MOOT        LD IX,STWND:CALL RRESB        JP GOTRDOS;---------------------------------------MOO1    LD A,#FF:CALL MNG0        LD A,1:CALL MNGC_PL        LD HL,#C000,DE,#0000,BC,#4000        LDIR:RST 0;-------        LD A,(CUZ)        LD HL,BITZ-1,B,0,C,A:ADD HL,BC        DI        LD BC,#DFF7,A,NV29AF:OUT A        LD B,#BF:IN A        OR A:JR Z,TMA        PUSH HL,BC,AF        LD A,#FE:CALL MNG0        LD HL,#0000+8,DE,DRT,BC,4:LDIR        POP AF,BC,HLTMA     OR (HL):OUT A        LD BC,VFDD:OUT A        LD A,#FE:CALL MNG0        LD HL,#0000+8        LD A,#FF.3      LD (HL),A:INC HL        LD (HL),A        CALL MNG0D        RET;-------MOOT    LD A,(CUZ)        DEC A:JR Z,DRVA        DEC A:JR Z,DRVB        DEC A:JR Z,DRVCDRVD    LD A,#FD:CALL MNGC        JR DRVn;-------DRVC    LD A,#FD:CALL MNGC        JR DRVN;-------DRVB    LD A,#FC:CALL MNGCDRVn    LD DE,#E000,BC,#0000-4        JR DRVX;-------DRVA    LD A,#FC:CALL MNGCDRVN    LD DE,#C000,BC,#E000DRVX    PUSH DE,BC:CALL CHTOSEP        POP DE,BC        LD HL,(DABB):ADD HL,BC:CALL FFllMOO2    LD HL,(CUZ),H,0        LD BC,DRT-1:ADD HL,BC        LD A,(MCZ),(HL),A        LD A,#FE:CALL MNG0        LD A,2:CALL MNGC_PL        LD HL,DRT,DE,#C000+8,BC,4:LDIR        LD A,(BLKT),(DE),A        LD HL,#C000,DE,#0000,BC,#2000        LDIR        CALL MNG0D        RET;-------FFll    EX DE,HL        OR A:SBC HL,DE:RET C,Z        LD BC,HL:DEC BC        LD HL,DE:INC DE        LD (HL),#FF        LDIR        RET;---------------------------------------MOUNTRS XOR A:LD (MCZ),A;      0 - RS232        JP MOUNT;---------------------------------------MOUNRAM LD IX,STWND:CALL PRWOW        LD HL,TXT4,DE,#0101:CALL TXTPR        CALL SCL_RAM        LD IX,STWND:CALL RRESB;-------        LD A,5,(MCZ),A;     5 - RAM DISK        CALL MOUNT        JP GOTRDOS;---------------------------------------DIZMAUN LD A,(CUZ)        LD HL,ZITZ-1,B,0,C,A:ADD HL,BC        PUSH BC        DI        LD BC,#DFF7,A,NV29AF:OUT A        LD B,#BF        IN A:AND (HL):OUT A        LD A,#FE:CALL MNGC        POP BC;-------        LD HL,#C008-1:ADD HL,BC        LD (HL),#FF        RET;---------------------------------------SCL_RAM XOR A:LD (EOC),A        LD HL,LOBU,B,8        PUSH HL:CALL LOAD512        POP HL        LD B,8,DE,SINC:CALL CHEE:RET NZ        LD A,(HL):DEC A:CP 128:RET NC;-------        LD A,RAMD,(PGRAMD),A:CALL MNGC        EXX        LD HL,#C000,DE,HL:INC DE        LD BC,(256*9)-1,(HL),0:LDIR        EXX        LD DE,#0100,(#C000+14),DE        LD DE,#C000        LD B,(HL):INC HLSCLF    PUSH BC        LD BC,14:LDIR        EX DE,HL        PUSH DE        DEC HL:LD B,(HL)        INC HL:LD A,(HL)        INC HL:LD D,(HL):CALL NFS        LD C,15:ADD HL,BC        LD (HL),A:INC HL        LD (HL),D        LD BC,0-15:ADD HL,BC        POP DE        EX DE,HL        POP BC        DJNZ SCLF        XOR A:LD (DE),A;-------        PUSH HL;              _        CALL HAUDEH,CAT9C        POP HL;-------        EX DE,HL        LD HL,LOBE:OR A:SBC HL,DE        LD BC,HL        EX DE,HL        LD DE,#C000+#1000:LDIR;-------DSCL    EX DE,HLLDSCL   LD A,(EOC):CP #0F:RET Z        LD B,1:CALL LOAD512        LD (EOC),A        LD A,H:CP #C0:JR NC,LDSCL        LD A,(PGRAMD)        INC A:CP RAMDE:RET NC        LD (PGRAMD),A:CALL MNGC        LD BC,HL,HL,0,DE,#C000:LDIR        JR DSCL;---------------------------------------NFS     INC A:CP 16:JR C,JEKTOR:INC D        XOR AJEKTOR  DJNZ NFS        RETADDSUM  LD HL,0,DE,0        EXX        LD HL,#C000,DE,13,B,128DSU     LD A,(HL):OR A:RET Z        ADD HL,DE        LD A,(HL)        EXX        LD E,A        ADD HL,DE        EXX        INC HL,HL,HL        DJNZ DSU        RETCAT9C   EXX        LD HL,#C8EA,DE,HL:INC DE        LD BC,9-1,(HL),32:LDIR        LD A,#10,(#C000+#08E7),A        EXX        LD A,129:SUB B        LD (#C000+#08E4),A        LD A,C,(#C000+#08F4),A        DEC HL:LD D,(HL)        DEC HL:LD A,(HL)        DEC HL:LD B,(HL):CALL NFS        LD E,A,(#C000+#08E1),DE        CALL ADDSUM:EXX        EX DE,HL:LD HL,2544        OR A:SBC HL,DE:RET C        LD (#C000+#08E5),HL        XOR A        RET; _HAUDEH  LD HL,#C000,DE,16,BC,#8100HEHA    LD A,(HL):OR A:RET Z        CP 1:JR NZ,$+3:INC C        ADD HL,DE        DJNZ HEHA        OR A        RET;-------CHEE    LD A,(DE):CP (HL):RET NZ        INC HL,DE        DJNZ CHEE        RET;---------------------------------------CHECK   LD C,(IX+29)        LD HL,CHE,B,0:ADD HL,BC        LD A,(HL),(MCZ),A        LD A,C;0 - IDEnemo, 1 - SD(ZC), 2 - SD(NGS)        CP 0:RET Z        CP 1:RET Z        LD IX,ERWND:CALL PRWOW        LD HL,TE01,DE,#0101:CALL TXTPR        LD A,%00101010:CALL PRIAT        CALL USPO        CALL NUSP        LD IX,ERWND:CALL RRESB        LD A,1:OR A        RET;---------------------------------------EXTCHE  PUSH HL,DE        CALL TENTRY;-------        LD HL,ENTRY+8,DE,TRD        CALL TN:LD A,0:JR Z,YUKSEK        LD HL,ENTRY+8,DE,SCL        CALL TN:LD A,1:JR Z,YUKSEK;-------YUKSEK  POP DE,HL        OR A        RET;---------------------------------------TN_LD A,(DE):CP (HL):RET NZ:INC HL,DE_LD A,(DE):CP (HL):RET NZ:INC HL,DE_LD A,(DE):CP (HL)        RET;---------------------------------------MNG0    LD BC,PW0:OUT A:RETMNG0D   LD BC,PW0,A,(#6000):OUT A:RETMNGC    LD (#6003),A,BC,PW3:OUT A:RET;---------------------------------------MNGC_PL EXA:XOR A:JP WLDPRWOW   LD A,1:JP WLDRRESB   LD A,2:JP WLDPRSRW   LD A,3:JP WLDPRIAT   EXA:LD A,4:JP WLDCURSOR  LD A,6:JP WLDCURSER  LD A,7:JP WLDYN      EXA:LD A,8:JP WLDTXTPR   LD A,11:JP WLDMEZZ    EXA:LD A,12:JP WLD;-------GEDPL   LD A,15:JP WLD;-------UPPP    LD A,17:JP WLDDWWW    LD A,18:JP WLDENKE    LD A,22:JP WLDESC     LD A,23:JP WLDUSPO    LD A,46:JP WLDNUSP    LD A,47:JP WLD;-------LOAD512 LD A,48:JP WLDTENTRY  LD DE,ENTRY,A,51:JP WLDCHTOSEP LD A,52:JP WLD;---------------------------------------PLWND   DB 0,0        DB 30,10;    X,Y        DB 18+2,6+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 2,0;      LINESCUZ     DB 1,4        DB %11110001,0;-------MEWND   DB 0,0        DB 30,11;    X,Y        DB 18+2,2+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINESCUZ2    DB 1,2        DB %11110001,0;-------ERWND   DB 0,0        DB 23,12;    X,Y        DB 32+2,1+2; W,H        DB %00101111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES;-------STWND   DB 0,0        DB 24,12;    X,Y        DB 32+2,1+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES;-------TRWND   DB 2,0        DB 24,11;    X,Y        DB 32+2,3+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0000;    BUFFER        DB 0,0;      LINES        DB 1,3        DB %11110000,0        DW 0        DW 0        DW TRWCTRWC    DB #0E,"RESET to TR-DOS",13        DB #0E,"RESET to Basic128",13        DB #0E,"BACK TO COMMANDER",0;-------BITZ    DB %00000001        DB %00000010        DB %00000100        DB %00001000ZITZ    DB %11111110        DB %11111101        DB %11111011        DB %11110111;-------CHE     DB 1        DB 3        DS 6;-------TXT0    DB "Mount TRD to:"TXT1    DB "Mount RS232 to:"TXT2    DB "Dismounting:"TXT3    DB "SCL as RAM disk:"TXT4    DB #0B,2,8,"Copying SCL to "        DB "RAM disk!!!",0TXT5    DB #0B,3,8,"Mounting TRD to "        DB "vDOS!!!",0T01     DB "Mount "TNAME   DB "12345678.123 "TE01    DB "This Device is NOT "        DB "supported!!!",0ME01    DB "    Drive A     ",13ME02    DB "    Drive B     ",13ME03    DB "    Drive C     ",13ME04    DB "    Drive D     ",0ME05    DB " <Mount RS-232> ",13        DB "<Dismount Drive>",0;IDNT    DB 0,"vTR-DOS MDLn2!",0;---------------------------------------SPC     DB "   "RS2     DB "COM"RAM     DB "RAM"TRD     DB "TRD"SCL     DB "SCL"SINC    DB "SINCLAIR"DRT     DB #FF;0-RS232,1/2-HDD,3-SD(ZC)        DB #FF;4-*SD(NGS)        DB #FF;5-RAM DISK        DB #FFDAHL    DS 2DADE    DS 2DABB    DS 2MCZ     NOPMCC     NOPPGRAMD  NOPEOC     NOPESTAT   NOPENTRY   DS 32;---------------------------------------        ORG EMU        INCB "EMU"        ORG EMU+#4000        INCB "MN3O";---------------------------------------